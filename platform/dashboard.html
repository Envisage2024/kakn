<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - KAKN Sites</title>
    <link rel="icon" type="image/x-icon" href="../images/logo.png">
    <script>try{ if (localStorage.getItem('sidebarCollapsed') === 'true') document.documentElement.classList.add('sidebar-collapsed'); }catch(e){};</script>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Small centered spinner used while dashboard sections load */
        .section-spinner{display:flex;align-items:center;justify-content:center;padding:18px;min-height:64px}
        .loader{width:28px;height:28px;border:4px solid rgba(0,0,0,0.12);border-top-color:#2d9cdb;border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
    </style>
</head>
<body>
    <div class="app-container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <img src="../images/logo.png" alt="KAKN Sites logo" class="site-logo">
                    <span class="logo-text">KAKN Sites</span>
                </div>
                <button class="toggle-btn" id="toggleSidebar">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item active">
                    <i class="fas fa-home"></i>
                    <span class="nav-text">Dashboard</span>
                </a>
                <a href="assignments.html" class="nav-item">
                    <i class="fas fa-tasks"></i>
                    <span class="nav-text">Assignments</span>
                </a>
                <a href="live-sessions.html" class="nav-item">
                    <i class="fas fa-video"></i>
                    <span class="nav-text">Live Sessions</span>
                </a>
                <a href="tutorials.html" class="nav-item">
                    <i class="fas fa-play-circle"></i>
                    <span class="nav-text">Video Tutorials</span>
                </a>
                <a href="notes.html" class="nav-item">
                    <i class="fas fa-file-pdf"></i>
                    <span class="nav-text">Notes</span>
                </a>
                <a href="support.html" class="nav-item">
                    <i class="fas fa-comment-dots"></i>
                    <span class="nav-text">One-on-One Support</span>
                </a>
                <a href="forum.html" class="nav-item">
                    <i class="fas fa-users"></i>
                    <span class="nav-text">Group Forum</span>
                </a>
                <a href="certificate.html" class="nav-item">
                    <i class="fas fa-certificate"></i>
                    <span class="nav-text">Certificate</span>
                </a>
                <a href="#" class="nav-item logout" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="nav-text">Logout</span>
                </a>
            </nav>
        </aside>

        <main class="main-content">
            <header class="top-header">
                <div class="header-left">
                    <button class="mobile-toggle" id="mobileToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h2>Dashboard</h2>
                </div>
                <div class="header-right">
                    <div class="user-info">
                        <span class="user-name" id="userName">Welcome, User</span>
                        <div class="user-avatar">
                            <i class="fas fa-user-circle"></i>
                        </div>
                    </div>
                </div>
            </header>

            <div class="content-area">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon orange">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <div class="stat-details">
                            <h3 id="pendingAssignments"></h3>
                            <p>Pending Assignments</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon purple">
                            <i class="fas fa-play-circle"></i>
                        </div>
                        <div class="stat-details">
                            <h3 id="newVideos"></h3>
                            <p>New Video Tutorials</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon green">
                            <i class="fas fa-file-pdf"></i>
                        </div>
                        <div class="stat-details">
                            <h3 id="newNotes"></h3>
                            <p>New PDF Notes</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon teal">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div class="stat-details">
                            <h3 id="newMessages"></h3>
                            <p>New Messages</p>
                        </div>
                    </div>
                </div>

                <div class="dashboard-sections">
                    <div class="section-card">
                        <div class="section-header">
                            <h3><i class="fas fa-clock"></i> Recent Activity</h3>
                        </div>
                        <div class="activity-list" id="activityList">
                            <!-- intentionally left blank; spinner will show while loading -->
                        </div>
                    </div>

                    <div class="section-card">
                        <div class="section-header">
                            <h3><i class="fas fa-calendar-alt"></i> Upcoming Sessions</h3>
                        </div>
                        <div class="sessions-list" id="sessionsList">
                            <!-- intentionally left blank; spinner will show while loading -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="js/main.js"></script>
    <script src="js/dashboard.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const sessionsList = document.getElementById('sessionsList');
        const activityList = document.getElementById('activityList');

        function showSpinner(container){ if(!container) return; container.innerHTML = '<div class="section-spinner"><div class="loader"></div></div>'; }

        // show blank then spinner while loading
        if (sessionsList) { sessionsList.innerHTML = ''; showSpinner(sessionsList); }
        if (activityList) { activityList.innerHTML = ''; showSpinner(activityList); }

        // Load single live session from local JSON file and render it
        // First try Firestore REST for the `sessions/current` doc to match admin data
        async function fetchFirestoreCurrent() {
            try {
                const project = 'kakn-sites-7c4e9';
                const url = `https://firestore.googleapis.com/v1/projects/${project}/databases/(default)/documents/sessions/current`;
                const res = await fetch(url);
                if (!res.ok) return null;
                const json = await res.json();
                const f = json.fields || {};
                return {
                    title: f.title && f.title.stringValue ? f.title.stringValue : '',
                    topic: f.topic && f.topic.stringValue ? f.topic.stringValue : '',
                    date: f.date && f.date.stringValue ? f.date.stringValue : '',
                    startTime: f.startTime && f.startTime.stringValue ? f.startTime.stringValue : '',
                    endTime: f.endTime && f.endTime.stringValue ? f.endTime.stringValue : '',
                    presenter: f.instructor && f.instructor.stringValue ? f.instructor.stringValue : (f.presenter && f.presenter.stringValue ? f.presenter.stringValue : ''),
                    room: f.room && f.room.stringValue ? f.room.stringValue : '',
                    active: f.active && f.active.booleanValue ? true : false
                };
            } catch (e) { console.debug('fetchFirestoreCurrent failed', e); return null; }
        }

        // local JSON fallback paths
        const pathsToTry = ['./data/live-session.json', 'data/live-session.json', '/platform/data/live-session.json'];

        function tryNext(paths) {
            if (!paths.length) return Promise.reject(new Error('No paths left'));
            const p = paths.shift();
            return fetch(p).then(res => {
                if (!res.ok) throw new Error('not ok');
                return res.json();
            }).catch(() => tryNext(paths));
        }

        // central rendering function reused for both Firestore and JSON shapes
        function processSession(session) {
            if (!session || !session.title) return;
            // Clear existing sessions and render one
            sessionsList.innerHTML = '';
            const item = document.createElement('div');
            item.className = 'session-item';

            // Support both formats: { start/end ISO, time } and Firestore-style { date, startTime, endTime }
            let day = '';
            let month = '';
            let dateObj = null;
            if (session.start) dateObj = new Date(session.start);
            else if (session.date) dateObj = new Date(session.date);
            else if (session.startDate) dateObj = new Date(session.startDate);
            if (dateObj && !isNaN(dateObj.getTime())) {
                day = '' + dateObj.getDate();
                month = dateObj.toLocaleString(undefined, { month: 'short' }).toUpperCase();
            } else {
                day = session.day || '';
                month = (session.month || '').toUpperCase();
            }

            // Determine displayed time: prefer explicit `session.time` or Firestore `startTime`/`endTime`
            const timeFromJson = session.time && session.time.toString().trim();
            const startTimeField = (session.startTime || session.start_time || session.starttime || '').toString().trim();
            const endTimeField = (session.endTime || session.end_time || session.endtime || '').toString().trim();
            const displayTime = timeFromJson || (startTimeField ? `${startTimeField}${endTimeField ? ' - ' + endTimeField : ''}` : (session.time || ''));

            item.innerHTML = `
                <div class="session-date">
                    <span class="date-day">${day}</span>
                    <span class="date-month">${month}</span>
                </div>
                <div class="session-info">
                    <h4>${session.title}</h4>
                    ${session.topic ? `<p class="session-line"><i class="fas fa-book-open"></i> <strong>Topic:</strong> ${session.topic}</p>` : ''}
                    <p class="session-line"><i class="fas fa-calendar-alt"></i> ${formatDateRange(dateObj, session.end, displayTime)}</p>
                    ${session.presenter || session.instructor ? `<p class="session-line"><i class="fas fa-user"></i> ${session.presenter || session.instructor}</p>` : ''}
                    
                </div>
            `;

            sessionsList.appendChild(item);

            function formatDateRange(startOrDateObj, endIsoOrUnused, fallbackTime) {
                try {
                    let s = null;
                    if (startOrDateObj instanceof Date) s = startOrDateObj;
                    else if (typeof startOrDateObj === 'string') s = new Date(startOrDateObj);
                    if (!s || isNaN(s.getTime())) return fallbackTime || '';
                    const e = endIsoOrUnused ? new Date(endIsoOrUnused) : null;
                    const optionsDate = { year: 'numeric', month: 'short', day: 'numeric' };
                    const optionsTime = { hour: 'numeric', minute: '2-digit' };
                    const dateStr = s.toLocaleDateString(undefined, optionsDate);
                    const timeStr = fallbackTime || (e && !isNaN(e.getTime()) ? `${s.toLocaleTimeString(undefined, optionsTime)} - ${e.toLocaleTimeString(undefined, optionsTime)}` : s.toLocaleTimeString(undefined, optionsTime));
                    return `${dateStr} Â· ${timeStr}`;
                } catch (e) {
                    return fallbackTime || '';
                }
            }
        }

        // When the dashboard signals data-ready, render the stored session (keeps spinner until sync)
        document.addEventListener('dashboard-data-ready', function onDashboardReady() {
            try { if (window.__fetchedSession) processSession(window.__fetchedSession); }
            catch(e) {}
            document.removeEventListener('dashboard-data-ready', onDashboardReady);
        });

        // Try Firestore REST first, then fallback to local files
        fetchFirestoreCurrent()
            .then(session => {
                if (session && session.title) {
                    // store session and mark session fetch complete; render happens on dashboard-data-ready
                    window.__fetchedSession = session;
                    try { if (window.__resolveSessionReady) { window.__resolveSessionReady(); window.__resolveSessionReady = null; } } catch(e){}
                } else {
                    return tryNext(pathsToTry.slice()).then(res => { window.__fetchedSession = res; try { if (window.__resolveSessionReady) { window.__resolveSessionReady(); window.__resolveSessionReady = null; } } catch(e){} });
                }
            })
            .catch((err) => {
                // if firestore attempt fails, try local json
                tryNext(pathsToTry.slice()).then(res => { window.__fetchedSession = res; try { if (window.__resolveSessionReady) { window.__resolveSessionReady(); window.__resolveSessionReady = null; } } catch(e){} }).catch(e => { console.warn('live-session.json not loaded:', e); if (sessionsList) sessionsList.innerHTML = ''; try { if (window.__resolveSessionReady) { window.__resolveSessionReady(); window.__resolveSessionReady = null; } } catch(e){} });
            });
    });
    </script>
</body>
</html>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script>
    // Firebase config (same as login page)
    const firebaseConfig = {
      apiKey: "AIzaSyB5kckado_jqgb1z_oRrLrP90bLvBUZGQs",
      authDomain: "kakn-sites-7c4e9.firebaseapp.com",
      databaseURL: "https://kakn-sites-7c4e9-default-rtdb.firebaseio.com",
      projectId: "kakn-sites-7c4e9",
      storageBucket: "kakn-sites-7c4e9.firebasestorage.app",
      messagingSenderId: "628096383132",
      appId: "1:628096383132:web:26ceb9e11094fe87191559",
      measurementId: "G-VX7S6Y1YN6"
    };
    if (!window.firebase || !firebase.apps || firebase.apps.length === 0) {
        firebase.initializeApp(firebaseConfig);
    }
    firebase.auth().onAuthStateChanged(function(user) {
        if (!user) {
            // Not signed in -> redirect to platform login
            window.location.href = 'index.html';
        }
    });
</script>

